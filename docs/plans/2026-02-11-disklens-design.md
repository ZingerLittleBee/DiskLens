# DiskLens 设计文档

**版本：** 1.0
**日期：** 2026-02-11
**作者：** DiskLens Team

---

## 1. 项目概述

### 1.1 项目定位

DiskLens 是一个高性能的磁盘空间分析工具，使用 Rust + ratatui 构建 TUI 界面，专注于：
- 快速并发扫描（支持从 GB 到 TB 级别）
- 直观的圆环图可视化
- 智能缓存和增量更新
- 详细的实时反馈

### 1.2 核心功能

**扫描功能：**
- 快速解析存储空间结构，分析文件和文件夹占用详情
- 支持输入路径参数来分析，不输入则默认分析整个磁盘
- 实时显示当前正在分析的文件信息
- 支持从小规模（GB 级）到大规模（TB 级）的磁盘分析

**可视化功能：**
- 左侧圆环图：直观显示目录占用比例
- 右侧列表视图：详细显示文件/文件夹信息
- 钻取式导航：可以深入查看文件夹内部情况
- 自适应合并：小文件/文件夹自动合并显示（默认 1% 阈值）

**增强功能：**
- 搜索/过滤：在结果中搜索特定文件或文件夹
- 排序：按大小、名称、修改时间排序
- 书签：标记关注的目录，快速跳转
- 多格式导出：JSON、Markdown、HTML

**性能特性：**
- 混合并发模型：tokio 异步 + rayon 并行
- 智能缓存：增量扫描，提升重复分析速度
- 不阻塞系统：限流控制，避免 I/O 过载
- 友好的用户提示：详细的进度反馈和错误信息

---

## 2. 技术栈

### 2.1 核心依赖

**UI 层：**
- `ratatui` (0.28+)：TUI 框架
- `crossterm` (0.28+)：跨平台终端控制

**并发引擎：**
- `tokio` (1.42+)：异步运行时（用于 I/O 密集操作）
- `rayon` (1.10+)：数据并行库（用于 CPU 密集计算）
- `dashmap` (6.1+)：无锁并发 HashMap

**存储和序列化：**
- `serde` (1.0+)：序列化/反序列化
- `bincode` (1.3+)：二进制缓存格式（快速）
- `serde_json` (1.0+)：JSON 导出

**文件系统：**
- `walkdir` (2.5+)：目录遍历
- `tokio::fs`：异步文件操作

**数据可视化：**
- 自定义实现圆环图（基于 ratatui 的 Canvas widget）
- `unicode-width` (0.2+)：准确计算文本宽度

**其他：**
- `clap` (4.5+)：命令行参数解析
- `anyhow` (1.0+)：错误处理
- `chrono` (0.4+)：时间处理

---

## 3. 核心架构

### 3.1 目录结构

```
disklens/
├── src/
│   ├── main.rs              # 程序入口，CLI 参数解析
│   ├── app.rs               # 应用状态管理
│   ├── core/
│   │   ├── mod.rs
│   │   ├── scanner.rs       # 并发扫描引擎
│   │   ├── analyzer.rs      # 数据分析和聚合
│   │   ├── cache.rs         # 缓存管理器
│   │   └── progress.rs      # 进度追踪
│   ├── models/
│   │   ├── mod.rs
│   │   ├── node.rs          # 文件/目录节点
│   │   └── scan_result.rs   # 扫描结果
│   ├── ui/
│   │   ├── mod.rs
│   │   ├── app_state.rs     # UI 状态机
│   │   ├── renderer.rs      # 主渲染器
│   │   ├── events.rs        # 事件处理
│   │   └── widgets/
│   │       ├── mod.rs
│   │       ├── ring_chart.rs    # 圆环图
│   │       ├── file_list.rs     # 文件列表
│   │       ├── breadcrumb.rs    # 面包屑
│   │       ├── progress_bar.rs  # 进度条
│   │       └── help_panel.rs    # 帮助面板
│   └── export/
│       ├── mod.rs
│       ├── json.rs          # JSON 导出
│       ├── markdown.rs      # Markdown 导出
│       └── html.rs          # HTML 导出
├── tests/                   # 集成测试
├── benches/                 # 性能基准测试
└── docs/                    # 文档
```

### 3.2 数据流

```
1. 扫描阶段：Scanner → Progress → UI (实时更新)
2. 分析阶段：Scanner → Analyzer → Cache → UI
3. 交互阶段：UI Events → App State → Renderer
4. 导出阶段：App State → Exporter → 文件
```

### 3.3 模块职责

**core/scanner**：并发扫描文件系统，收集文件/目录信息
**core/analyzer**：分析扫描结果，计算大小、百分比、合并小项
**core/cache**：管理扫描结果缓存，支持增量更新
**core/progress**：追踪扫描进度，提供实时反馈
**models**：核心数据结构定义
**ui**：TUI 界面实现，包含各种 widget
**export**：多格式报告导出

---

## 4. 并发扫描引擎

### 4.1 扫描器架构

**核心思路：** 混合并发模型 - 目录级并行 + 异步 I/O

```rust
// 核心结构
struct Scanner {
    thread_pool: rayon::ThreadPool,           // 工作线程池
    progress_tx: mpsc::Sender<Progress>,      // 进度通知通道
    result_map: Arc<DashMap<PathBuf, Node>>,  // 并发安全的结果集
    config: ScanConfig,                       // 扫描配置
}

struct ScanConfig {
    max_depth: Option<usize>,      // 最大深度限制
    parallel_limit: usize,         // 并发数（默认 CPU 核心数 × 2）
    follow_symlinks: bool,         // 是否跟随符号链接
    merge_threshold: f64,          // 合并阈值（默认 1%）
    ignore_patterns: Vec<String>,  // 忽略模式
}
```

### 4.2 扫描流程

1. **初始化**：创建线程池和通信通道
2. **BFS 遍历**：从根目录开始，广度优先
3. **任务分发**：每个子目录作为独立任务提交到线程池
4. **并发执行**：工作线程并发处理目录
5. **结果聚合**：使用 DashMap 无锁收集结果
6. **进度报告**：定期发送进度更新到 UI 线程

### 4.3 错误处理

- 捕获权限错误、I/O 错误等
- 不中断扫描，继续处理其他路径
- 记录错误信息到 `ScanResult.errors`
- 实时发送错误通知到 UI

---

## 5. 数据模型

### 5.1 核心数据结构

```rust
// 文件/目录节点
#[derive(Debug, Clone, Serialize, Deserialize)]
struct Node {
    path: PathBuf,
    name: String,
    size: u64,                    // 字节
    size_on_disk: u64,            // 实际磁盘占用（考虑块大小）
    node_type: NodeType,
    children: Vec<Node>,          // 子节点
    file_count: usize,            // 文件数量（递归）
    dir_count: usize,             // 目录数量（递归）
    modified: Option<SystemTime>, // 最后修改时间
    percentage: f64,              // 占父目录的百分比
}

#[derive(Debug, Clone, Serialize, Deserialize)]
enum NodeType {
    File,
    Directory,
    Symlink,
    Other,
}

// 扫描结果
struct ScanResult {
    root: Node,
    total_size: u64,
    total_files: usize,
    total_dirs: usize,
    scan_duration: Duration,
    errors: Vec<ScanError>,       // 扫描错误列表
    timestamp: SystemTime,        // 扫描时间戳
}

// 扫描错误
#[derive(Debug, Clone, Serialize, Deserialize)]
struct ScanError {
    path: PathBuf,
    error_type: ErrorType,
    message: String,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
enum ErrorType {
    PermissionDenied,
    NotFound,
    IoError,
    Other,
}
```

### 5.2 数据优化

- 使用 `Arc` 共享大型数据结构，避免克隆
- 对小于阈值的节点延迟计算 percentage
- 使用 `SmallVec` 优化小目录的 children 存储

---

## 6. UI 组件设计

### 6.1 界面布局

```
┌─────────────────────────────────────────────────────────────────┐
│ DiskLens v0.1.0 | / > Users > zingerbee > Documents            │ ← 顶部：标题 + 面包屑
├────────────────────────────┬────────────────────────────────────┤
│                            │  Name          Size       %        │
│                            │  ────────────────────────────────  │
│         ╱───╲              │  📁 Projects   15.2 GB    45.3%   │
│       ╱       ╲            │  📁 Photos     8.7 GB     25.9%   │
│      │         │           │  📁 Downloads  5.1 GB     15.2%   │
│      │  圆环图  │           │  📁 Videos     3.2 GB      9.5%   │ ← 中间：左侧圆环图 + 右侧列表
│      │         │           │  📄 Others     1.4 GB      4.1%   │
│       ╲       ╱            │                                    │
│         ╲───╱              │  Total: 33.6 GB / 256 items       │
│                            │                                    │
├────────────────────────────┴────────────────────────────────────┤
│ ⚠️  跳过: /System/Library - 权限拒绝 | 已扫描: 1,234 文件      │ ← 底部：状态栏 + 错误提示
├──────────────────────────────────────────────────────────────────┤
│ ↑↓:导航 Enter:进入 u:返回 /:搜索 s:排序 b:书签 x:导出 ?:帮助 q:退出 │ ← 快捷键提示
└──────────────────────────────────────────────────────────────────┘
```

### 6.2 Widget 职责

**RingChart（圆环图）:**
- 绘制彩色圆环，每个扇区代表一个子项
- 高亮当前选中的扇区
- 显示扇区的名称和百分比标签
- 支持鼠标悬停提示（可选）

**FileList（文件列表）:**
- 显示当前目录的子项（名称、大小、百分比）
- 支持上下滚动、高亮选中项
- 图标区分文件/目录/符号链接
- 显示人类可读的大小格式（KB/MB/GB/TB）

**Breadcrumb（面包屑）:**
- 显示当前路径层级
- 使用 ` > ` 分隔符

**ProgressBar（进度条）:**
- 显示扫描进度百分比
- 显示当前扫描的文件路径
- 显示扫描速度和预估剩余时间

**HelpPanel（帮助面板）:**
- 按 `?` 键显示完整的快捷键列表
- 分类显示（导航、操作、视图等）

### 6.3 快捷键设计

**导航：**
- `↑↓` 或 `jk`：上下移动
- `←→` 或 `hl`：左右切换焦点（圆环图 ↔ 列表）
- `Enter`：进入选中的目录
- `Backspace` 或 `u`：返回上级目录
- `gg`：跳到第一项
- `G`：跳到最后一项

**操作：**
- `/`：搜索/过滤
- `s`：排序切换（大小 → 名称 → 时间）
- `b`：添加/移除书签
- `e`：查看错误日志
- `r`：刷新/重新扫描
- `x`：导出报告
- `c`：清除缓存

**视图：**
- `t`：切换阈值（0.5% / 1% / 2% / 5%）
- `?`：显示/隐藏帮助面板
- `q`：退出

---

## 7. 缓存和增量扫描

### 7.1 缓存策略

**缓存位置：** `~/.disklens/cache/`

**缓存文件命名：**
```
{path_hash}.cache        # 扫描结果（bincode 格式）
{path_hash}.meta         # 元数据（JSON 格式）
```

**元数据结构：**
```rust
struct CacheMeta {
    original_path: PathBuf,
    scan_timestamp: SystemTime,
    total_size: u64,
    file_count: usize,
    checksum: u64,               // 目录结构的快速校验和
}
```

### 7.2 增量扫描流程

1. **加载缓存**：
   - 读取缓存的元数据
   - 检查缓存是否过期（可配置，默认 24 小时）

2. **增量检测**：
   - 遍历目录，比较修改时间 (mtime)
   - 如果目录的 mtime 未变，跳过扫描，使用缓存
   - 如果变化，只扫描变化的子树

3. **合并结果**：
   - 缓存的未变部分 + 新扫描的变化部分
   - 重新计算大小和百分比

4. **更新缓存**：
   - 扫描完成后，更新缓存文件
   - 异步写入，不阻塞 UI

### 7.3 缓存管理

- 用户可选择清除缓存（按 `c` 键）
- 自动清理超过 30 天的缓存
- 在设置中显示缓存占用空间

---

## 8. 错误处理策略

### 8.1 分级错误处理

**Level 1 - 实时提示（扫描时）:**
- 在底部状态栏滚动显示最新错误
- 格式：`⚠️ 跳过: {路径} - {原因}`
- 自动消失或被新错误覆盖
- 不中断扫描流程

**Level 2 - 错误摘要（扫描完成后）:**
```
扫描完成！
✓ 成功: 12,345 个文件/目录
⚠️ 跳过: 23 个项目
  - 权限拒绝: 18
  - 符号链接循环: 3
  - 其他错误: 2

按 'e' 查看详细错误列表
```

**Level 3 - 详细错误列表（按 'e' 键）:**
```
┌─────────────────────────────────────────┐
│         错误详情 (23 项)                │
├─────────────────────────────────────────┤
│ ⚠️  /System/Library/CoreServices        │
│     权限拒绝                            │
│                                         │
│ ⚠️  /private/var/db                     │
│     权限拒绝                            │
│                                         │
│ 🔁 /Users/link -> /Users/target         │
│     符号链接循环                        │
├─────────────────────────────────────────┤
│ ↑↓:滚动 c:复制路径 Esc:关闭            │
└─────────────────────────────────────────┘
```

**Level 4 - 导出报告中的错误日志:**
- JSON: `errors` 字段包含完整错误列表
- Markdown: "## 扫描错误" 章节
- HTML: 可折叠的错误列表

### 8.2 错误恢复

- 所有错误都不中断扫描
- 记录错误但继续处理其他路径
- 对于严重错误（如磁盘满），提示用户并优雅退出

---

## 9. 导出功能设计

### 9.1 导出流程

**触发方式：** 按 `x` 键打开导出菜单

**导出菜单：**
```
┌─────────────────────────────────────────┐
│         导出报告                        │
├─────────────────────────────────────────┤
│  [1] JSON - 结构化数据                  │
│  [2] Markdown - 人类可读                │
│  [3] HTML - 交互式报告                  │
│  [4] 全部导出                           │
│                                         │
│  保存位置: ~/disklens_report_{timestamp}│
│                                         │
│  [Esc] 取消                             │
└─────────────────────────────────────────┘
```

### 9.2 各格式详细设计

**JSON 格式：**
```json
{
  "version": "1.0",
  "scan_info": {
    "path": "/Users/zingerbee",
    "timestamp": "2026-02-11T16:30:00Z",
    "duration_secs": 45.2
  },
  "summary": {
    "total_size": 123456789,
    "file_count": 5432,
    "dir_count": 234
  },
  "tree": { ... },
  "errors": [ ... ]
}
```

**Markdown 格式：**
```markdown
# 磁盘分析报告

## 扫描信息
- 路径: /Users/zingerbee
- 时间: 2026-02-11 16:30:00
- 用时: 45.2 秒

## 摘要
- 总大小: 115.2 GB
- 文件数: 5,432
- 目录数: 234

## 占用排行 (Top 20)
| 名称 | 类型 | 大小 | 占比 |
|------|------|------|------|
| Projects | 📁 | 45.2 GB | 39.2% |
| Photos | 📁 | 32.1 GB | 27.8% |
...

## 扫描错误
- /System/Library - 权限拒绝
...
```

**HTML 格式：**
- 包含交互式圆环图（使用 Chart.js 或纯 CSS）
- 可折叠的树状视图
- 响应式设计，支持移动端
- 内嵌 CSS/JS，单文件即可打开

---

## 10. 性能优化策略

### 10.1 扫描性能优化

**1. 并发控制：**
- 动态调整并发数：监控 I/O 等待时间
- 如果 I/O 等待高 → 降低并发数（避免磁盘颠簸）
- 如果 CPU 空闲高 → 提高并发数（充分利用资源）

**2. 内存优化：**
- 流式处理：不一次性加载所有数据到内存
- 对于超大目录（>10 万文件），使用迭代器而非 Vec
- 及时释放已处理完的节点数据

**3. I/O 优化：**
- 批量读取文件元数据（fstat）
- 使用 `metadata()` 而非 `symlink_metadata()`（除非需要）
- 预读优化：提示操作系统顺序读取

**4. 缓存命中优化：**
- 使用 LRU 缓存最近访问的目录
- 缓存文件系统元数据（避免重复 stat 调用）

### 10.2 UI 渲染优化

**1. 增量渲染：**
- 只重绘变化的区域，不是整个屏幕
- 使用 ratatui 的 diff 算法

**2. 节流和防抖：**
- 进度更新节流：最多每 100ms 更新一次
- 键盘事件防抖：避免快速按键导致的卡顿

**3. 圆环图优化：**
- 预计算扇区坐标，缓存绘制路径
- 使用 Unicode 块字符（▀▄█）提升绘制效果

**4. 虚拟滚动：**
- 列表视图只渲染可见区域的行
- 对于超长列表（>1000 项），使用虚拟滚动

### 10.3 基准测试目标

- 小规模（1GB / 1万文件）：< 5 秒
- 中规模（100GB / 10万文件）：< 30 秒
- 大规模（1TB / 100万文件）：< 5 分钟

---

## 11. 开发路线图

### Phase 1: 核心功能（MVP）

**目标：** 基本可用的磁盘分析工具

- [ ] 基础项目结构和依赖配置
- [ ] 数据模型实现（Node, ScanResult）
- [ ] 简单的单线程扫描器
- [ ] 基本的 TUI 界面（列表视图）
- [ ] 显示扫描进度
- [ ] JSON 格式导出

**预计时间：** 1-2 周

### Phase 2: 并发和性能

**目标：** 高性能并发扫描

- [ ] 实现混合并发模型（tokio + rayon）
- [ ] 无锁数据结构（DashMap）
- [ ] 错误处理和权限问题处理
- [ ] 性能基准测试和优化
- [ ] 进度追踪优化（详细的实时反馈）

**预计时间：** 1-2 周

### Phase 3: 可视化增强

**目标：** 圆环图和交互体验

- [ ] 实现圆环图 Widget
- [ ] 钻取式导航（Enter/Backspace）
- [ ] 面包屑导航
- [ ] 左右分栏布局
- [ ] 自适应阈值合并小文件
- [ ] 颜色主题和视觉优化

**预计时间：** 1 周

### Phase 4: 高级功能

**目标：** 增强实用性

- [ ] 智能缓存系统
- [ ] 增量扫描
- [ ] 搜索/过滤功能
- [ ] 排序功能（大小/名称/时间）
- [ ] 书签功能
- [ ] Markdown 和 HTML 导出
- [ ] 完整的键盘快捷键支持

**预计时间：** 1-2 周

### Phase 5: 完善和发布

**目标：** 生产就绪

- [ ] 完整的单元测试和集成测试
- [ ] 文档编写（README, 使用指南）
- [ ] 错误处理完善
- [ ] 跨平台测试（macOS, Linux, Windows）
- [ ] 性能调优
- [ ] 发布到 crates.io

**预计时间：** 1 周

---

## 12. 总结

DiskLens 采用经典的 MVC 分层架构，核心特性包括：

1. **高性能并发扫描**：混合并发模型（tokio + rayon），支持从 GB 到 TB 级别的磁盘
2. **直观的可视化**：圆环图 + 列表视图，钻取式导航
3. **智能缓存**：增量扫描，大幅提升重复分析速度
4. **完善的错误处理**：分级错误提示，不中断扫描流程
5. **多格式导出**：JSON、Markdown、HTML
6. **丰富的交互**：Vim 风格快捷键，搜索、排序、书签等功能

整个项目预计 6-8 周完成，分为 5 个开发阶段。
